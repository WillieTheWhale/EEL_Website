<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Vision Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
            background: linear-gradient(180deg, #151518 0%, #0a0a0c 100%);
            overflow: hidden;
            height: 100vh;
        }
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .title {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.28);
            z-index: 100;
            pointer-events: none;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <h1 class="title">Apple Vision Pro</h1>
    <div class="loading" id="loading">Loading...</div>
    <canvas id="canvas"></canvas>

    <!-- Three.js r128 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Post-processing addons -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <!-- Vision Pro Modules -->
    <script src="modules/visionpro/VisionProConfig.js"></script>
    <script src="modules/visionpro/GeometryPrimitives.js"></script>
    <script src="modules/visionpro/VisionProGeometry.js"></script>
    <script src="modules/visionpro/VisionProHDRI.js"></script>
    <script src="modules/visionpro/VisionProMaterials.js"></script>
    <script src="modules/visionpro/VisionProLighting.js"></script>
    <script src="modules/visionpro/VisionProPostProcessing.js"></script>
    <script src="modules/visionpro/VisionProAssembly.js"></script>

    <script>
        // =====================================================
        // APPLE VISION PRO - PHOTOREALISTIC IMPLEMENTATION
        // =====================================================

        const config = window.VISION_PRO_CONFIG;

        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0c0c0e);

        // Camera setup
        const camera = new THREE.PerspectiveCamera(
            config.camera.fov,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(...config.camera.position);
        camera.lookAt(0, 0, 0);

        // Renderer setup with high quality settings
        const renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('canvas'),
            antialias: true,
            powerPreference: 'high-performance'
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // Build Vision Pro model
        let visionProAssembly;

        // ASYNC initialization
        async function init() {
            try {
                // Create assembly with camera reference for post-processing
                visionProAssembly = new VisionProAssembly(scene, renderer, config, camera);
                await visionProAssembly.build();

                // Hide loading message
                document.getElementById('loading').style.display = 'none';

                // Start render loop
                animate();
            } catch (error) {
                console.error('Error building Vision Pro:', error);
                document.getElementById('loading').textContent = 'Error loading model';
            }
        }

        // =====================================================
        // INTERACTION CONTROLS
        // =====================================================
        let isDragging = false;
        let prevMouse = { x: 0, y: 0 };

        document.addEventListener('mousedown', e => {
            isDragging = true;
            prevMouse = { x: e.clientX, y: e.clientY };
        });

        document.addEventListener('mouseup', () => isDragging = false);

        document.addEventListener('mousemove', e => {
            if (isDragging && visionProAssembly) {
                const deltaX = (e.clientX - prevMouse.x) * 0.005;
                const deltaY = (e.clientY - prevMouse.y) * 0.005;
                visionProAssembly.rotate(deltaX, deltaY);
                prevMouse = { x: e.clientX, y: e.clientY };
            }
        });

        // Touch support
        document.addEventListener('touchstart', e => {
            if (e.touches && e.touches.length > 0) {
                isDragging = true;
                prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        document.addEventListener('touchend', () => isDragging = false);

        document.addEventListener('touchmove', e => {
            if (isDragging && visionProAssembly && e.touches && e.touches.length > 0) {
                const deltaX = (e.touches[0].clientX - prevMouse.x) * 0.005;
                const deltaY = (e.touches[0].clientY - prevMouse.y) * 0.005;
                visionProAssembly.rotate(deltaX, deltaY);
                prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });

        // Double-click to reset angle
        document.addEventListener('dblclick', () => {
            if (visionProAssembly) {
                visionProAssembly.resetRotation();
            }
        });

        // =====================================================
        // RENDER LOOP
        // =====================================================
        function animate() {
            requestAnimationFrame(animate);

            // Use assembly's render method (handles post-processing)
            if (visionProAssembly) {
                visionProAssembly.render();
            } else {
                renderer.render(scene, camera);
            }
        }

        // =====================================================
        // RESIZE HANDLER
        // =====================================================
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);

            // Update post-processing size
            if (visionProAssembly) {
                visionProAssembly.resize(width, height);
            }
        });

        // =====================================================
        // INITIALIZE
        // =====================================================
        init();
    </script>
</body>
</html>
